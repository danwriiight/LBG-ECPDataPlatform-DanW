# Deployment for the IoT Processor application running on GKE
apiVersion: apps/v1
kind: Deployment
metadata:
  name: iot-processor
  namespace: default   # Modify if using different namespace
  labels:
    app: iot-processor
spec:
  # Number of application replicas for scalability and resilience
  replicas: 2
  # Selector that identifies which Pods belong to this Deployment
  selector:
    matchLabels:
      app: iot-processor
  template:
    metadata:
      labels:
        app: iot-processor
    spec:
      # Kubernetes ServiceAccount used by Pods for Workload Identity
      serviceAccountName: consumer-sa   # MUST match var.ksa_binding.ksa_name

      containers:
      - name: iot-processor
        # Container image stored in Artifact Registry
        image: europe-west2-docker.pkg.dev/lbg-ecpdataplatform/iot-processor-repo/iot-processor:dev
        imagePullPolicy: Always

        # Load environment variables from ConfigMap
        envFrom:
        - configMapRef:
            name: iot-processor-config

        # Resource guarantees and safety limits
        resources:
          requests:
            cpu: "200m"
            memory: "256Mi"
          limits:
            cpu: "500m"
            memory: "512Mi"

        # Delay shutdown slightly to allow Pub/Sub processing to finish
        # Helps prevent message loss on shutdown
        lifecycle:
          preStop:
            exec:
              command: ["/bin/sh", "-c", "sleep 5"]

# Probes disabled (python-slim image does not include pgrep)
# TODO: Replace with proper HTTP probe when service is exposed
# readinessProbe:
#   exec:
#     command: ["pgrep", "python"]

# livenessProbe:
#   exec:
#     command: ["pgrep", "python"]

